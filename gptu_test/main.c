#include <pmb887x.h>
/*
WRITE[4] F4900000: 00000100 (GPTU0_CLC): RMC(0x01) (PC: 004010B8, LR: 00400584)
WRITE[4] F4900010: 0003003C (GPTU0_T01IRS): T0AINS(BYPASS) | T0BINS(CONCAT) | T0CINS(CONCAT) | T0DINS(BYPASS) | T1AINS(BYPASS) | T1BINS(BYPASS) | T1CINS(BYPASS) | T1DINS(BYPASS) | T0AREL | T0BREL (PC: 004010B8, LR: 00400584)
 READ[4] F4900014: 00000000 (GPTU0_T01OTS): SOUT00(A) | SOUT01(A) | STRG00(A) | STRG01(A) | SSR00(A) | SSR01(A) | SOUT10(A) | SOUT11(A) | STRG10(A) | STRG11(A) | SSR10(A) | SSR11(A) (PC: 004010B8, LR: 00400584)
WRITE[4] F4900014: 00000200 (GPTU0_T01OTS): SOUT00(A) | SOUT01(A) | STRG00(A) | STRG01(A) | SSR00(C) | SSR01(A) | SOUT10(A) | SOUT11(A) | STRG10(A) | STRG11(A) | SSR10(A) | SSR11(A) (PC: 004010B8, LR: 00400584)
 READ[4] F49000DC: 00000000 (GPTU0_SRSEL): SSR7(START_A) | SSR6(START_A) | SSR5(START_A) | SSR4(START_A) | SSR3(START_A) | SSR2(START_A) | SSR1(START_A) | SSR0(START_A) (PC: 004010B8, LR: 00400584)
WRITE[4] F49000DC: 0000000C (GPTU0_SRSEL): SSR7(SR00) | SSR6(START_A) | SSR5(START_A) | SSR4(START_A) | SSR3(START_A) | SSR2(START_A) | SSR1(START_A) | SSR0(START_A) (PC: 004010B8, LR: 00400584)
WRITE[4] F4900038: 00D06480 (GPTU0_T0CBA): T0A(0x80) | T0B(0x64) | T0C(0xD0) (PC: 004010B8, LR: 00400584)
WRITE[4] F4900060: 00000007 (GPTU0_T012RUN): T0ARUN | T0BRUN | T0CRUN (PC: 004010B8, LR: 00400584)
 READ[4] F49000FC: 00000000 (GPTU0_SRC0) (PC: 0040118C, LR: 00400778)
*/
int main(void) {
	wdt_init();
	
	GPTU_CLC(GPTU0) = (100 << MOD_CLC_RMC_SHIFT);
	
	// C -> B -> A
	// Concat B + C
	GPTU_T01IRS(GPTU0) =
		GPTU_T01IRS_T0BINS_CONCAT |
		GPTU_T01IRS_T0CINS_CONCAT |
		GPTU_T01IRS_T0AREL |
		GPTU_T01IRS_T0BREL;
	
	// Trigger on T0C overflow
	GPTU_T01OTS(GPTU0) = GPTU_T01OTS_SSR00_A;
	GPTU_SRSEL(GPTU0) = GPTU_SRSEL_SSR0_SR00;
	
	// D C B A
	GPTU_T0CBA(GPTU0) = 0;
	// GPTU_T0CBA(GPTU0) = (0x80 << GPTU_T0CBA_T0A_SHIFT) | (0x64 << GPTU_T0CBA_T0B_SHIFT) | (0xD0 << GPTU_T0CBA_T0C_SHIFT);
	
	GPTU_T012RUN(GPTU0) = GPTU_T012RUN_T0ARUN;
	
	stopwatch_t start = stopwatch_get();
	uint32_t cnt = 0;
	while (!(GPTU_SRC0(GPTU0) & MOD_SRC_SRR)) {
		uint32_t new_cnt = GPTU_T0CBA(GPTU0);
		if (new_cnt > cnt)
			cnt = new_cnt;
	}
	uint32_t elapsed = stopwatch_elapsed(start);
	
	printf("elapsed: %d ns [%d]\n", elapsed, cnt);
	
	return 0;
}

__IRQ void data_abort_handler(void) {
	printf("data_abort_handler\n");
	while (true);
}

__IRQ void undef_handler(void) {
	printf("undef_handler\n");
	while (true);
}

__IRQ void prefetch_abort_handler(void) {
	printf("prefetch_abort_handler\n");
	while (true);
}
