#include "main.h"

void sleep();
void nop();

void _start() {
	init_sdram();
	enable_irq(0);
	enable_fiq(0);
	set_einit(0);
	disable_first_whatchdog();
	set_einit(1);
	init_watchdog();
	
	int i;
	
	pmb8876_serial_print("init i2c...\n");
	
	// Init I2C
	REG(GPIO_I2C_SCL) = 0xFFFF8300; // [PS=1; DATA=1; DIR=IN; ENAQ=1]
	REG(GPIO_I2C_SCL) = 0x00001211; // [PS=0; IS=ALT0; OS=ALT0; DATA=1; DIR=IN; PPEN=1]
	REG(GPIO_I2C_SDA) = 0xFFFF8300; // [PS=1; DATA=1; DIR=IN; ENAQ=1]
	REG(GPIO_I2C_SDA) = 0x00001211; // [PS=0; IS=ALT0; OS=ALT0; DATA=1; DIR=IN; PPEN=1]
	
	pmb8876_serial_print("do pickoff...\n");
	
	for (i = 0; i < 1024; ++i) {
		// do pickoff!!!!!!!111111111111111111111111111111
		REG(0xF7600000) = 0x00000400;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600020) = 0x00080000;
		REG(0xF7600028) = 0x00030022;
		REG(0xF7600018) = 0x0004003D;
		REG(0xF7600010) = 0x00000001;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600078) = 0x0000007F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF7600078) = 0x0000003F;
		REG(0xF7600084) = 0x0000003F;
		REG(0xF7600084) = 0x0000FFC0;
		sleep();
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600000) = 0x00000001;
		
		REG(0xF7600000) = 0x00000400;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600020) = 0x00080000;
		REG(0xF7600028) = 0x00030022;
		REG(0xF7600018) = 0x0004003D;
		REG(0xF7600010) = 0x00000001;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600078) = 0x0000007F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF7600084) = 0x0000003F;
		REG(0xF7600034) = 0x00000002;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600000) = 0x00000001;
		sleep();
		
		REG(0xF7600000) = 0x00000400;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600020) = 0x00280000;
		REG(0xF7600028) = 0x00030022;
		REG(0xF7600018) = 0x0004003D;
		REG(0xF7600010) = 0x00000001;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600078) = 0x0000007F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600034) = 0x00000003;
		REG(0xF7608000) = 0x00244462;
		REG(0xF760008C) = 0x00000001;
		REG(0xF7600078) = 0x00000020;
		sleep();
		REG(0xF760008C) = 0x00000020;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600000) = 0x00000001;
		
		REG(0xF7600000) = 0x00000400;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600020) = 0x00280000;
		REG(0xF7600028) = 0x00030022;
		REG(0xF7600018) = 0x0004003D;
		REG(0xF7600010) = 0x00000001;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600078) = 0x0000007F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600034) = 0x00000003;
		REG(0xF7608000) = 0x005F4662;
		REG(0xF760008C) = 0x00000001;
		REG(0xF7600078) = 0x00000020;
		sleep();
		REG(0xF760008C) = 0x00000020;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600000) = 0x00000001;
		
		REG(0xF7600000) = 0x00000400;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600020) = 0x00280000;
		REG(0xF7600028) = 0x00030022;
		REG(0xF7600018) = 0x0004003D;
		REG(0xF7600010) = 0x00000001;
		REG(0xF760008C) = 0x0000003F;
		REG(0xF7600078) = 0x0000007F;
		REG(0xF7600068) = 0x0000000F;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600034) = 0x00000003;
		REG(0xF7608000) = 0x00084262;
		REG(0xF760008C) = 0x00000001;
		REG(0xF7600078) = 0x00000020;
		sleep();
		REG(0xF760008C) = 0x00000020;
		REG(0xF7600084) = 0x0000FFC0;
		REG(0xF7600010) = 0x00000000;
		REG(0xF7600000) = 0x00000001;
	}
	while (1);
}

void sleep() {
	int i;
	for (i = 0; i < 100; ++i)
		serve_watchdog();
}

void nop() {
	serve_watchdog();
}